name: 'Collect Cabal Binaries'
description: 'Builds and collects the binaries for all provided cabal targets.'
inputs:
  targets:
    description: 'Cabal targets to build.'
    required: true
  dest:
    description: "Targets' binaries are copied here after being built."
    required: true
outputs:
  targets-json:
    description: "A JSON array of the input targets. Useful as an input to a job matrix."
    value: ${{ steps.collect.outputs.targets-json }}
runs:
  using: "composite"
  steps:
    - id: collect
      env:
        TARGETS: ${{ join(inputs.targets, ' ') }}
        DEST: ${{ inputs.dest }}
      run: |
        set -x
        echo "[$TARGETS]"
        if [ -z "$TARGETS" ]; then
            echo "::error::No targets were specified"
            exit 1
        fi
        mkdir -p $DEST
        cabal build $TARGETS
        cabal install $TARGETS --installdir=$DEST
        TARGETS_JSON=$(echo -n $TARGETS | jq -Rsc 'split(" ")')
        echo "::set-output name=targets-json::$TARGETS_JSON"
      shell: bash
